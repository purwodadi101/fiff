#!/bin/bash

# ========== Color Setup ==========
green="\e[38;5;87m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;130m"
orange="\e[38;5;99m"
yellow="\e[38;5;226m"
bold_white="\e[1;37m"
reset="\e[0m"

# Folder bot yang digunakan dan URL repo Anda
BOT_DIR="/root/tunnelftdor"
REPO_URL="https://github.com/carntech/tunnelftdor.git"
BOT_PORT="50123" # Port aplikasi Express/WebHook

# ========== Remove Previous Bot ==========
hapus_bot_lama() {
  echo -e "${orange}Menghapus bot lama...${neutral}"
  systemctl stop sellvpn.service 2>/dev/null
  systemctl disable sellvpn.service 2>/dev/null
  rm -f /etc/systemd/system/sellvpn.service
  rm -f /usr/bin/sellvpn /usr/bin/server_sellvpn /etc/cron.d/server_sellvpn
  rm -rf ${BOT_DIR}

  if command -v pm2 &> /dev/null;
  then
    pm2 delete sellvpn &> /dev/null
    pm2 save &> /dev/null
  fi

  systemctl daemon-reload
  echo -e "${green}Bot lama berhasil dihapus.${neutral}"
}

# ========== Install Dependencies ==========
pasang_package() {
  echo -e "${blue}Install dependensi sistem (Node.js, NPM, Git, SQLite3)...${reset}"

  apt update -y
  # Tambahkan sqlite3, dos2unix
  apt install -y npm nodejs curl dos2unix jq tmux git build-essential sqlite3

  npm install -g pm2
}

# ========== Setup Bot ==========
setup_bot() {
  timedatectl set-timezone Asia/Jakarta

  if [ -d ${BOT_DIR}/.git ];
  then
    echo -e "${yellow}Update repository dari Git...${reset}"
    cd ${BOT_DIR} && git pull
  else
    echo -e "${green}Cloning repository bot dari ${REPO_URL}...${reset}"
    git clone ${REPO_URL} ${BOT_DIR}
  fi
  
  if [ ! -d ${BOT_DIR} ]; then
      echo -e "${red}âŒ Gagal cloning repository. Pastikan URL repo sudah benar.${neutral}"
      exit 1
  fi
  cd ${BOT_DIR}

  # LOGIKA PENTING UNTUK TRIAL SCRIPT (.SH)
  echo -e "${yellow}Convert semua script ke format Unix (LF)...${reset}"
  # 1. Konversi semua skrip di folder BOT_DIR/scripts
  find ${BOT_DIR}/scripts -type f -name "*.sh" -exec dos2unix {} \; 2>/dev/null
  # 2. Konversi file JS utama dan file .sh lainnya di root bot
  find ${BOT_DIR} -maxdepth 1 -type f -name "*.sh" -exec dos2unix {} \; 2>/dev/null
  find ${BOT_DIR} -maxdepth 1 -type f -name "*.js" -exec dos2unix {} \; 2>/dev/null

  echo -e "${yellow}Install NPM packages (Termasuk pakasir-client dan node-cron)...${reset}"
  # Daftar semua modul Node.js yang digunakan di app.js
  npm install sqlite3 express crypto telegraf axios dotenv node-cron \
    pakasir-client winston || {
        echo -e "${red}âŒ Gagal saat instalasi NPM packages.${neutral}"
        echo -e "${yellow}âš ï¸ CATATAN PENTING:${reset}"
        echo -e "${yellow}Beberapa modul mungkin gagal terinstal. Jika PM2 error, coba instal manual:${reset}"
        echo -e "${bold_white}cd ${BOT_DIR} && npm install${reset}"
        echo -e "${bold_white}npm install sqlite3 express telegraf axios node-cron pakasir-client winston${reset}"
        sleep 5
    }

  # Pastikan semua skrip (.sh) dapat dieksekusi
  chmod +x ${BOT_DIR}/*
  chmod +x ${BOT_DIR}/scripts/*.sh 2>/dev/null
}

# ========== Konfigurasi Firewalld/UFW ==========
set_firewall() {
  echo -e "${yellow}Mengaktifkan firewall...${reset}"
  # Port default yang dibutuhkan bot: 22 (SSH), 80/443 (Web/Webhook), 50123 (Bot PM2)
  if command -v ufw &> /dev/null;
  then
    ufw allow 22
    ufw allow 80
    ufw allow 443
    ufw allow ${BOT_PORT}
    ufw allow ${BOT_PORT}/tcp
    ufw --force enable
  else
    echo -e "${orange}âš ï¸ UFW tidak terinstal. Melewati konfigurasi firewall.${reset}"
  fi
}

# ========== Konfigurasi Bot (Revisi sesuai app.js) ==========
server_app() {
  clear
  echo -e "${orange}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${neutral}"
  echo -e "   ${green}::: KONFIGURASI TUNNEL FT DOR :::${neutral}"
  echo -e "${orange}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${neutral}"
  echo -e "${yellow}Isi konfigurasi berikut untuk file ${BOT_DIR}/.vars.json${reset}"
  echo -e "${yellow}Variabel Pakasir dan Channel Telegram wajib diisi.${reset}"
 
  # --- INPUT DARI USER ---
  read -p "1. Masukkan Token Bot (BOT_TOKEN)           : " token
  read -p "2. Masukkan Admin ID (USER_ID)              : " adminid
  read -p "3. Masukkan ID Grup Notifikasi (GROUP_ID)   : " groupid
  read -p "4. Masukkan Username Channel (@channel)     : " channelusername
  read -p "5. Masukkan Nama Toko Anda (NAMA_STORE)     : " namastore
  read -p "6. Masukkan Pakasir API Key                 : " pakasirapikey
  read -p "7. Masukkan Pakasir Project Slug            : " pakasirslug
  read -p "8. Masukkan Webhook URL Anda (Cth: https://domain.com/webhook/pakasir) : " pakasirwebhookurl
  
  # --- MEMBUAT .VARS.JSON ---
  cat <<EOF > ${BOT_DIR}/.vars.json
{
  "BOT_TOKEN": "$token",
  "PORT": "${BOT_PORT}",
  "USER_ID": "$adminid",
  "GROUP_ID": "$groupid",
  "CHANNEL_USERNAME": "$channelusername",
  "NAMA_STORE": "$namastore",
  "PAKASIR_API_KEY": "$pakasirapikey",
  "PAKASIR_PROJECT_SLUG": "$pakasirslug",
  "PAKASIR_WEBHOOK_URL": "$pakasirwebhookurl"
}
EOF

  if ! jq empty ${BOT_DIR}/.vars.json 2>/dev/null; then
    echo -e "${red}âŒ Gagal membuat file .vars.json. Cek input atau format.${neutral}"
    exit 1
  fi


  # ğŸš€ Start PM2 bot
    
  echo -e "${green}Menjalankan bot dengan PM2...${reset}"
  # Perhatikan: Nama file utama di app.js adalah app.js
  pm2 start app.js --name sellvpn --cwd ${BOT_DIR} --log /var/log/sellvpn.log -- start
  pm2 save
  pm2 startup

  # ğŸ“© Notifikasi awal ke Admin
  curl -s -X POST https://api.telegram.org/bot$token/sendMessage \
    -d chat_id="$adminid" \
    -d text="âœ… Hai Mas!, Aku sudah aktif nih, gunakan /start di bot ini untuk melihat menu utama ya."

  echo -e "${green}Bot VPN telah aktif. Cek Telegram!${neutral}"
}

# ========== EXECUTOR ==========
if [[ ${1} == "sellvpn" ]];
then
  hapus_bot_lama
  pasang_package
  setup_bot
  set_firewall
  server_app
else
  echo -e "${red}Gunakan perintah: ${yellow}bash start sellvpn${neutral}"
  exit 1
fi
